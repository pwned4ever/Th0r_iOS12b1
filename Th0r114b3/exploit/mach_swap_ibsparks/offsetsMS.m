#include <errno.h>
#include <string.h>             // strcmp, strerror
#include <sys/utsname.h>        // uname

#include "common.h"             // LOG, kptr_t
#include "offsetsMS.h"

 static offsets_t *offsetsMS[] =
{
    &(offsets_t)
    {
        .constant =
        {
            .release = "18.",
            .kernel_image_base = 0xfffffff007004000,
        },
        .struct_offsets =
        {
            .proc_pid = 0x60,
            .proc_task = 0x10,
            .proc_ucred = 0xf8,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x358,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2e8,
            .task_all_image_info_addr = 0x398,
            .task_all_image_info_size = 0x3a0,
        },
        .iosurface =
        {
            .create_outsize = 0xdd0,
            .get_external_trap_for_index = 0xb7,
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .release = "17.",
            .kernel_image_base = 0xfffffff007004000,
        },
        .struct_offsets =
        {
            .proc_pid = 0x10,
            .proc_task = 0x18,
            .proc_ucred = 0x100,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x368,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2f0,
            .task_all_image_info_addr = 0x3a8,
            .task_all_image_info_size = 0x3b0,
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,
            .get_external_trap_for_index = 0xb7,
        },
    },
    NULL,
};

offsets_t *get_offsetsMS(void)
{
    struct utsname u;
    if (uname(&u) != 0)
    {
        LOG("uname: %s", strerror(errno));
        return 0;
    }
    
    for (size_t i = 0; offsetsMS[i] != 0; ++i)
    {
        if (strncmp(offsetsMS[i]->constant.release, u.release, strlen(offsetsMS[i]->constant.release)) == 0)
        {
            return offsetsMS[i];
        }
    }
    
    LOG("Failed to get offsets for kernel version: %s", u.version);
    return NULL;
}


/*
static offsets_t *offsetsMS[] =
{
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 18.2.0: Mon Nov 12 20:32:02 PST 2018; root:xnu-4903.232.2~1/RELEASE_ARM64_S8000",
            .kernel_image_base = 0xfffffff007004000,
        },
        .struct_offsets =
        {
            .proc_pid = 0x60,
            .proc_task = 0x10,
            .proc_ucred = 0xf8,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x358,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2e8,
            .task_all_image_info_addr = 0x398,
            .task_all_image_info_size = 0x3a0,
        },
        .iosurface = 
        {
            .create_outsize = 0xdd0,
            .get_external_trap_for_index = 0xb7,
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.7.0: Mon Jun 11 19:06:26 PDT 2018; root:xnu-4570.70.24~3/RELEASE_ARM64_S5L8960X",
            .kernel_image_base = 0xfffffff007004000,
        },
        .struct_offsets =
        {
            .proc_pid = 0x10,
            .proc_task = 0x18,
            .proc_ucred = 0x100,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x368,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2f0,
            .task_all_image_info_addr = 0x3a8,
            .task_all_image_info_size = 0x3b0,
        },
        .iosurface = 
        {
            .create_outsize = 0xbc8,
            .get_external_trap_for_index = 0xb7,
        },
    },
    
    
    
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 18.2.0: Mon Nov 12 20:32:02 PST 2018; root:xnu-4903.232.2~1/RELEASE_ARM64_T8010",
            .kernel_image_base = 0xfffffff007004000,
        },
        .struct_offsets =
        {
            .proc_pid = 0x60,
            .proc_task = 0x10,
            .proc_ucred = 0xf8,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x358,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2e8,
            .task_all_image_info_addr = 0x398,
            .task_all_image_info_size = 0x3a0,
        },
        .iosurface =
        {
            .create_outsize = 0xdd0,
            .get_external_trap_for_index = 0xb7,
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 18.2.0: Mon Nov 12 21:07:36 PST 2018; root:xnu-4903.232.2~2/RELEASE_ARM64_T8010",
            .kernel_image_base = 0xfffffff007004000,
        },

        .struct_offsets =
        {
            .proc_pid = 0x60,//-i7=1211b3
            .proc_task = 0x10,//-i7=1211b3
            .proc_ucred = 0xf8,//-i7=1211b3
            .task_vm_map = 0x20,//-i7=1211b3
            .task_bsd_info = 0x358,//-i7=1211b3
            .task_itk_self = 0xd8,//-i7=1211b3
            .task_itk_registered = 0x2e8,//-i7=1211b3
            .task_all_image_info_addr = 0x398,//-i7=1211b3
            .task_all_image_info_size = 0x3a0,//-i7=1211b3
        },
        .iosurface =
        {
            .create_outsize = 0xdd0,//-i7=1211b3
            .get_external_trap_for_index = 0xb7,//-i7=1211b3
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.7.0: Mon Jun 11 19:06:26 PDT 2018; root:xnu-4570.70.24~3/RELEASE_ARM64_S5L8960X",
            .kernel_image_base = 0xfffffff007004000,
        },

        .struct_offsets =
        {
            .proc_pid = 0x10,
            .proc_task = 0x18,
            .proc_ucred = 0x100,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x368,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2f0,
            .task_all_image_info_addr = 0x3a8,
            .task_all_image_info_size = 0x3b0,
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,
            .get_external_trap_for_index = 0xb7,
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 16.7.0: Thu Jun 15 18:33:35 PDT 2017; root:xnu-3789.70.16~4/RELEASE_ARM64_S5L8960X",
            .kernel_image_base = 0xfffffff007004000,
        },
        
        .struct_offsets =
        {
            .proc_pid = 0x10,
            .proc_task = 0x18,
            .proc_ucred = 0x100,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x360,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2e8,
            .task_all_image_info_addr = 0x3a0,
            .task_all_image_info_size = 0x3a8,
        },
        .iosurface =
        {
            .create_outsize = 0x3c8,
            .get_external_trap_for_index = 0xb7,
        },
    },
    
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.7.0: Mon Jun 11 19:06:26 PDT 2018; root:xnu-4570.70.24~3/RELEASE_ARM64_S5L8960X",
            .kernel_image_base = 0xfffffff007004000,
        },
        .struct_offsets =
        {
            .proc_pid = 0x10,
            .proc_task = 0x18,
            .proc_ucred = 0x100,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x368,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2f0,
            .task_all_image_info_addr = 0x3a8,
            .task_all_image_info_size = 0x3b0,
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,
            .get_external_trap_for_index = 0xb7,
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.7.0: Mon Jun 11 19:06:28 PDT 2018; root:xnu-4570.70.24~3/RELEASE_ARM64_T7000",
            .kernel_image_base = 0xfffffff007004000,
        },

        .struct_offsets =
        {
            .proc_pid = 0x10,//=6+1141
            .proc_task = 0x18,//=6+1141
            .proc_ucred = 0x100,//=6+1141
            .task_vm_map = 0x20,//=6+1141
            .task_bsd_info = 0x368,//=6+1141
            .task_itk_self = 0xe0,//=6+1141   i think ,,,,,         0xd8,//=6+1141
            .task_itk_registered = 0x2f0,
            .task_all_image_info_addr = 0x3a8,
            .task_all_image_info_size = 0x3b0,
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,
            .get_external_trap_for_index = 0xb7,
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.7.0: Mon Jun 11 19:06:26 PDT 2018; root:xnu-4570.70.24~3/RELEASE_ARM64_S5L8960X",
            .kernel_image_base = 0xfffffff007004000,
        },

        .struct_offsets =
        {
            .proc_pid = 0x10,
            .proc_task = 0x18,
            .proc_ucred = 0x100,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x368,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2f0,
            .task_all_image_info_addr = 0x3a8,
            .task_all_image_info_size = 0x3b0,
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,
            .get_external_trap_for_index = 0xb7,
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.6.0: Mon Apr 30 18:48:32 PDT 2018; root:xnu-4570.60.21~3/RELEASE_ARM64_S5L8960X",
            .kernel_image_base = 0xfffffff007004000,
        },

        .struct_offsets =
        {
            .proc_pid = 0x10,//=6+1141
            .proc_task = 0x18,//=6+1141
            .proc_ucred = 0x100,//=6+1141
            .task_vm_map = 0x20,//=6+1141
            .task_bsd_info = 0x368,//=6+1141
            .task_itk_self = 0xe0,//=6+1141   i think ,,,,,         0xd8,//=6+1141
            .task_itk_registered = 0x2f0,
            .task_all_image_info_addr = 0x3a8,
            .task_all_image_info_size = 0x3b0,
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,
            .get_external_trap_for_index = 0xb7,
        },
    },
    
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.7.0: Mon Jun 11 19:06:27 PDT 2018; root:xnu-4570.70.24~3/RELEASE_ARM64_T8015",
            .kernel_image_base = 0xfffffff007004000,
        },

        .struct_offsets =
        {
            .proc_pid = 0x10,//ix1141
            .proc_task = 0x18,//=ix1141
            .proc_ucred = 0x100,//=ix1141
            .task_vm_map = 0x20,//=ix1141
            .task_bsd_info = 0x368,//=ix1141
            .task_itk_self = 0xe0,//=ix1141
            .task_itk_registered = 0x2f0,//ix1141
            .task_all_image_info_addr = 0x3a8,//ix1141
            .task_all_image_info_size = 0x3b0,//ix1141
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,//ix1141
            .get_external_trap_for_index = 0xb7,//ix1141
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.3.0: Mon Nov  6 21:19:18 PST 2017; root:xnu-4570.32.1~1/RELEASE_ARM64_T7000",
            .kernel_image_base = 0xfffffff007004000,//= ipod6 11.2.1
        },

        .struct_offsets =
        {
            .proc_pid = 0x10,////= ipod6 11.2.1
            .proc_task = 0x18,//=//= ipod6 11.2.1
            .proc_ucred = 0x100,//=//= ipod6 11.2.1
            .task_vm_map = 0x20,//=//= ipod6 11.2.1
            .task_bsd_info = 0x368,//=//= ipod6 11.2.1
            .task_itk_self = 0xe0,//=//= ipod6 11.2.1
            .task_itk_registered = 0x2f0,////= ipod6 11.2.1
            .task_all_image_info_addr = 0x3a8,////= ipod6 11.2.1
            .task_all_image_info_size = 0x3b0,////= ipod6 11.2.1
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,////= ipod6 11.2.1
            .get_external_trap_for_index = 0xb7,////= ipod6 11.2.1
        },
    },
    
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.5.0: Tue Mar 13 21:32:11 PDT 2018; root:xnu-4570.52.2~8/RELEASE_ARM64_S8000",
            .kernel_image_base = 0xfffffff007004000,////= 11.3.1 - i8
        },
        
        .struct_offsets =
        {
            .proc_pid = 0x10,///= 11.3.1 - i8
            .proc_task = 0x18,///= 11.3.1 - i8
            .proc_ucred = 0x100,////= 11.3.1 - i8
            .task_vm_map = 0x20,////= 11.3.1 - i8
            .task_bsd_info = 0x368,////= 11.3.1 - i8
            .task_itk_self = 0xe0,///= 11.3.1 - i8
            .task_itk_registered = 0x2f0,///= 11.3.1 - i8
            .task_all_image_info_addr = 0x3a8,////= 11.3.1 - i8
            .task_all_image_info_size = 0x3b0,////= 11.3.1 - i8
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,///= 11.3.1 - i8
            .get_external_trap_for_index = 0xb7,///= 11.3.1 - i8
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.5.0: Tue Mar 13 21:32:12 PDT 2018; root:xnu-4570.52.2~8/RELEASE_ARM64_T8015",
            .kernel_image_base = 0xfffffff007004000,////= 11.3.1 - i8
        },
        
        .struct_offsets =
        {
            .proc_pid = 0x10,///= 11.3.1 - i8
            .proc_task = 0x18,///= 11.3.1 - i8
            .proc_ucred = 0x100,////= 11.3.1 - i8
            .task_vm_map = 0x20,////= 11.3.1 - i8
            .task_bsd_info = 0x368,////= 11.3.1 - i8
            .task_itk_self = 0xe0,///= 11.3.1 - i8
            .task_itk_registered = 0x2f0,///= 11.3.1 - i8
            .task_all_image_info_addr = 0x3a8,////= 11.3.1 - i8
            .task_all_image_info_size = 0x3b0,////= 11.3.1 - i8
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,///= 11.3.1 - i8
            .get_external_trap_for_index = 0xb7,///= 11.3.1 - i8
        },
    },
    &(offsets_t)
    {
        .constant =
        {
            .version = "Darwin Kernel Version 17.5.0: Tue Mar 13 21:32:11 PDT 2018; root:xnu-4570.52.2~8/RELEASE_ARM64_T8011",
            .kernel_image_base = 0xfffffff007004000,////= 11.3.1 - i8
        },
        
        .struct_offsets =
        {
            .proc_pid = 0x10,///= 11.3.1 - - ipadpro10.5 inch √
            .proc_task = 0x18,///= 11.3.1 - - ipadpro10.5 inch √
            .proc_ucred = 0x100,////= 11.3.1 - - ipadpro10.5 inch√
            .task_vm_map = 0x20,////= 11.3.1 - - ipadpro10.5 inch√
            .task_bsd_info = 0x368,////= 11.3.1 - - ipadpro10.5 inch√
            .task_itk_self = 0xe0,///= 11.3.1 - - ipadpro10.5 inch√
            .task_itk_registered = 0x2f0,///= 11.3.1 - - ipadpro10.5 inch
            .task_all_image_info_addr = 0x3a8,////= 11.3.1 - - ipadpro10.5 inch
            .task_all_image_info_size = 0x3b0,////= 11.3.1 - i- ipadpro10.5 inch8
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,///= 11.3.1 - - ipadpro10.5 inch
            .get_external_trap_for_index = 0xb7,///= 11.3.1 - - ipadpro10.5 inch
        },
    },
    
    
    
 
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    NULL,
};

offsets_t *get_offsetsMS(void)
{
    struct utsname u;
    if (uname(&u) != 0)
    {   LOG("uname: %s", u.machine);
        LOG("uname: %s", u.sysname);
        LOG("uname: %s", u.version);
        LOG("uname: %s", u.nodename);
        LOG("uname: %s", u.release);
        
        LOG("uname: %s", strerror(errno));
        return 0;
    }

    for (size_t i = 0; offsetsMS[i] != 0; ++i)
    {
        if (strcmp(u.version, offsetsMS[i]->constant.version) == 0)
        {
            return offsetsMS[i];
        }
    }

    LOG("Failed to get offsets for kernel version: %s", u.version);
    return NULL;
}
*/
