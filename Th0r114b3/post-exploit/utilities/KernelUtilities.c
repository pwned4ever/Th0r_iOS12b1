#include <CoreFoundation/CoreFoundation.h>
#include <stdio.h>
#include <stdlib.h>

#include <mach/mach.h>

#include "../../headers/common.h"
#include "../../headers/IOKit.h"

#include "KernelMemory.h"
#include "kernel_memory.h"
#include "offsets.h"
#include "KernelUtilities.h"
#include "kutils.h"
#include "../electra.h"
#include "exploit_additions.h"
//#include "find_port.h"

#define TF_PLATFORM 0x00000400 /* task is a platform binary */

uint64_t the_realhost;
uint64_t kernel_base;

void set_platform_binary(uint64_t proc)
{
    uint64_t task_struct_addr = MReadKernel64(proc + koffset(KSTRUCT_OFFSET_PROC_TASK));
    uint32_t task_t_flags = MReadKernel32(task_struct_addr + koffset(KSTRUCT_OFFSET_TASK_TFLAGS));
    task_t_flags |= TF_PLATFORM;
    MWriteKernel32(task_struct_addr + koffset(KSTRUCT_OFFSET_TASK_TFLAGS), task_t_flags);
}

uint64_t current_thread() {
    uint64_t thread_port = find_port(mach_thread_self());
    return rk64(thread_port + koffset(KSTRUCT_OFFSET_IPC_PORT_IP_KOBJECT));
}
